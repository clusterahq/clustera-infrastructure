name: Pulumi Deploy

on:
  push:
    branches:
      - main          # Deploy to production
      - development   # Deploy to development
      - staging       # Deploy to staging
      - testing       # Deploy to testing
  pull_request:
    branches:
      - main
      - development
      - staging
      - testing

jobs:
  preview:
    name: Pulumi Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    # Use environment based on target branch to access environment secrets
    environment:
      name: ${{ github.base_ref == 'main' && 'production' || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync

      - name: Determine stack from target branch
        id: stack
        run: |
          case "${{ github.base_ref }}" in
            main) echo "stack=production" >> $GITHUB_OUTPUT ;;
            development) echo "stack=development" >> $GITHUB_OUTPUT ;;
            staging) echo "stack=staging" >> $GITHUB_OUTPUT ;;
            testing) echo "stack=testing" >> $GITHUB_OUTPUT ;;
            *) echo "stack=development" >> $GITHUB_OUTPUT ;;
          esac

      - name: Configure GCP credentials
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json

      - name: Pulumi login to R2 backend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
          AWS_REGION: auto
        run: |
          uv run pulumi login "s3://clustera-infrastructure-pulumi?endpoint=${{ secrets.AWS_ENDPOINT_URL_S3 }}"

      - name: Pulumi preview
        uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: ${{ steps.stack.outputs.stack }}
          comment-on-pr: true
          comment-on-summary: true
        env:
          PULUMI_ACCESS_TOKEN: ""  # Not needed with R2 backend
          AIVEN_TOKEN: ${{ secrets.AIVEN_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
          AWS_REGION: auto
          GOOGLE_CREDENTIALS: /tmp/gcp-key.json

  deploy:
    name: Pulumi Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    permissions:
      contents: read
      id-token: write

    # Dynamically set environment based on branch
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || (github.ref_name == 'staging' && 'staging' || (github.ref_name == 'testing' && 'testing' || 'development')) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync

      - name: Determine stack from branch
        id: stack
        run: |
          case "${{ github.ref_name }}" in
            main) echo "stack=prod" >> $GITHUB_OUTPUT ;;
            development) echo "stack=development" >> $GITHUB_OUTPUT ;;
            staging) echo "stack=staging" >> $GITHUB_OUTPUT ;;
            testing) echo "stack=testing" >> $GITHUB_OUTPUT ;;
            *) echo "stack=development" >> $GITHUB_OUTPUT ;;
          esac

      - name: Configure GCP credentials
        run: |
          printf '%s' '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json

      - name: Pulumi login to R2 backend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
          AWS_REGION: auto
        run: |
          uv run pulumi login "s3://clustera-infrastructure-pulumi?endpoint=${{ secrets.AWS_ENDPOINT_URL_S3 }}"

      - name: Pulumi up
        uses: pulumi/actions@v5
        with:
          command: up
          stack-name: ${{ steps.stack.outputs.stack }}
          upsert: false  # Fail if stack doesn't exist
        env:
          PULUMI_ACCESS_TOKEN: ""  # Not needed with R2 backend
          AIVEN_TOKEN: ${{ secrets.AIVEN_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
          AWS_REGION: auto
          GOOGLE_CREDENTIALS: /tmp/gcp-key.json

      - name: Export stack outputs
        if: success()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
          AWS_REGION: auto
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: |
          uv run pulumi stack output --json > stack-outputs.json
          echo "Stack outputs saved to stack-outputs.json"

      - name: Upload stack outputs as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pulumi-outputs-${{ steps.stack.outputs.stack }}
          path: stack-outputs.json
          retention-days: 30
